<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Genesis — Voice Chat (Super Simple)</title>
<style>
  :root{--bg:#0f0a1a;--ink:#e8e6ff;--line:#3a3450;--panel:#141421;--violet:#8b5cf6}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Inter,Roboto,Arial}
  .wrap{max-width:820px;margin:0 auto;padding:20px}
  h1{margin:0 0 8px}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  button,input{padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:#1a1a2e;color:var(--ink);font-weight:700}
  button{cursor:pointer}
  .log{border:1px solid var(--line);background:var(--panel);padding:12px;border-radius:14px;min-height:180px;white-space:pre-wrap}
  .badge{font-size:12px;opacity:.8}
  .pill{display:inline-block;background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:#000;padding:6px 10px;border-radius:999px;font-weight:800}
</style>
</head>
<body>
<div class="wrap">
  <h1>Genesis — Voice Chat <span class="pill">Phase 1</span></h1>
  <p class="badge">Mic → STT → Amethyst reply → DangerousGem voice (fallback to browser TTS)</p>

  <div class="row">
    <button id="start">🎙 Start Listening</button>
    <button id="stop">■ Stop</button>
    <button id="mute">🔇 Mute</button>
    <span id="stt" class="badge">STT: idle</span>
    <span id="tts" class="badge" style="margin-left:auto">Voice: checking…</span>
  </div>

  <div class="row">
    <input id="typeBox" placeholder="(optional) type to Amethyst…" style="flex:1"/>
    <button id="send">Send</button>
  </div>

  <div class="log" id="log"></div>
</div>

<script>
const VOICE_SERVER = 'https://dangerousgem.onrender.com/speak'; // your Render server
const logEl = document.getElementById('log');
const sttEl = document.getElementById('stt');
const ttsEl = document.getElementById('tts');

function log(line){ logEl.textContent += line + '\\n'; logEl.scrollTop = logEl.scrollHeight; }

// Health check (non-fatal)
fetch(VOICE_SERVER.replace('/speak','/health'))
  .then(r=>{ ttsEl.textContent = r.ok ? 'Voice: DangerousGem online' : 'Voice: error'; })
  .catch(()=>{ ttsEl.textContent = 'Voice: offline (fallback ready)'; });

/* ------- SIMPLE ENGINE ------- */
function amethystReply(text){
  const t = String(text||'').trim();
  if(!t) return "…(soft shimmer)…";
  return `${t}'s tail ❤️❤️❤️`;
}

/* ------- SPEAK (Server → fallback) ------- */
let speakOn = true;
let speaking = false;

async function playServerVoice(text){
  const res = await fetch(VOICE_SERVER, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ text })
  });
  if(!res.ok) throw new Error('voice server error');
  const blob = await res.blob();
  const url = URL.createObjectURL(blob);
  try{
    const audio = new Audio(url);
    await audio.play();
  } finally {
    URL.revokeObjectURL(url);
  }
}

function speakBrowser(text){
  if(!('speechSynthesis' in window)) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  const vs = speechSynthesis.getVoices();
  u.voice = vs.find(v => /en/i.test(v.lang) && /(Jenny|Samantha|Google|Microsoft|Victoria)/i.test(v.name)) || vs[0];
  u.pitch = 1.2; u.rate = 0.95;
  window.speechSynthesis.speak(u);
}

async function speak(text){
  if(!speakOn || speaking) return;
  speaking = true;
  try{
    await playServerVoice(text);
    ttsEl.textContent = 'Voice: DangerousGem (live)';
  }catch{
    speakBrowser(text);
    ttsEl.textContent = 'Voice: browser (fallback)';
  }finally{
    speaking = false;
  }
}

/* ------- INPUT: TYPE ------- */
const box = document.getElementById('typeBox');
document.getElementById('send').onclick = async ()=>{
  const v = box.value.trim();
  if(!v) return;
  log('Zed: ' + v);
  const reply = amethystReply(v);
  log('Amethyst: ' + reply);
  await speak(reply);
  box.value = '';
};

/* ------- INPUT: MIC (Web Speech API) ------- */
let rec=null, recognizing=false;

function makeRecognizer(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ alert('Web Speech API not supported on this browser'); return null; }
  const r = new SR();
  r.continuous = true; r.interimResults = true; r.lang = 'en-US';
  r.onstart = ()=>{ recognizing=true; sttEl.textContent='STT: listening…'; };
  r.onend = ()=>{ recognizing=false; sttEl.textContent='STT: stopped'; };
  r.onerror = e=>{ recognizing=false; sttEl.textContent='STT: error'; log('STT error: '+e.error); };
  r.onresult = async ev=>{
    let finalText='';
    for(let i=ev.resultIndex;i<ev.results.length;i++){
      const tr = ev.results[i];
      if(tr.isFinal) finalText += tr[0].transcript;
    }
    if(finalText){
      log('Zed (voice): ' + finalText);
      const reply = amethystReply(finalText);
      log('Amethyst: ' + reply);
      await speak(reply);
    }
  };
  return r;
}

document.getElementById('start').onclick = ()=>{
  if(recognizing) return;
  rec = makeRecognizer(); if(!rec) return;
  // Unlock audio on user gesture (policies)
  try{ new Audio().play().catch(()=>{}); }catch{}
  rec.start();
};
document.getElementById('stop').onclick = ()=>{ if(rec && recognizing) rec.stop(); };
document.getElementById('mute').onclick = ()=>{
  speakOn = !speakOn;
  document.getElementById('mute').textContent = speakOn ? '🔇 Mute' : '🔊 Unmute';
};
</script>
</body>
</html>
