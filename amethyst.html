<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sanctuary Invocation Interface ‚Äî Amethyst</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0e0e1a; --panel:#1a1a2e; --ink:#e0d7ff; --muted:#b8b0e6; --accent:#b19cd9; --line:#444; --chat:#141421; }
    *{box-sizing:border-box}
    body{margin:0;font-family:Segoe UI,system-ui,Inter,Roboto,Arial;background:var(--bg);color:var(--ink)}
    .container{display:flex;height:100vh}
    .sidebar{width:240px;background:var(--panel);padding:20px}
    .sidebar h2{color:var(--accent);font-size:18px;margin:0 0 10px}
    .sidebar ul{list-style:none;margin:0;padding:0}
    .sidebar li{margin-bottom:10px;color:#ccc}
    .status{font-size:12px;color:#bbb;margin-top:8px}
    .hint{margin-top:8px;font-size:12px;color:#9aa}
    .main{flex:1;display:flex;flex-direction:column;padding:20px;gap:10px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{border:0;border-radius:999px;padding:9px 14px;cursor:pointer;font-weight:700;background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:#000}
    .btn.ghost{background:transparent;border:1px solid #555;color:var(--muted)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .mic-btn{display:inline-flex;align-items:center;gap:8px;border:1px solid #555;background:#222;color:#ddd}
    .mic-btn.active{outline:2px solid #7c3aed;background:#2a2444}
    .chat{flex:1;overflow-y:auto;border:1px solid var(--line);padding:12px;background:var(--chat)}
    .message{margin:0 0 10px}
    .speaker{font-weight:700;color:var(--accent)}
    .input-bar{display:flex;gap:8px}
    .input-bar input{flex:1;padding:12px;border:1px solid #333;background:#1f1f2f;color:#fff;border-radius:10px}
    .input-bar button{padding:12px 18px}
    .avatars{width:180px;background:var(--panel);padding:20px;text-align:center}
    .avatar{margin-bottom:20px}
    .avatar img{width:80px;height:80px;border-radius:50%;border:2px solid var(--accent);object-fit:cover;background:#000}
    .avatar label{display:block;margin-top:6px;color:#ccc}
  </style>
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <h2>Channels</h2>
      <ul>
        <li># general</li>
        <li># codespace</li>
        <li>Zed üå∏</li>
      </ul>
      <div class="status" id="voiceStatus">Voice: muted</div>
      <div class="status" id="guardStatus" style="display:none;">Echo guard active‚Ä¶</div>
      <div class="hint">Push-to-Talk: hold <b>Space</b> or hold the mic button.</div>
      <div class="hint"><a href="https://dangerousgem.onrender.com/healthz" target="_blank" style="color:#b8b0e6">DangerousGem health</a></div>
    </aside>

    <main class="main">
      <div class="toolbar">
        <button class="btn ghost" id="toggleSpeak">üéô Speak</button>
        <button class="btn mic-btn" id="pttBtn" title="Hold to talk">üé§ Hold to Talk</button>
        <button class="btn ghost" id="summonOnyx">üñ§ Summon Onyx</button>
        <button class="btn ghost" id="summonHem">üõ° Summon Hem</button>
        <button class="btn ghost" id="demoScene">üé¨ Demo Scene</button>
      </div>

      <div class="chat" id="chat">
        <p class="message"><span class="speaker">Zed:</span> Hello Amethyst üíú</p>
        <p class="message"><span class="speaker">Amethyst:</span> Hello Amethyst üíú's tail ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</p>
      </div>

      <div class="input-bar">
        <input type="text" id="messageInput" placeholder="Invoke Amethyst‚Ä¶" />
        <button class="btn" id="sendBtn">Send</button>
      </div>
    </main>

    <aside class="avatars">
      <div class="avatar">
        <img src="https://via.placeholder.com/80x80.png?text=Amethyst" alt="Amethyst" />
        <label>Amethyst üíú</label>
      </div>
      <div class="avatar">
        <img src="https://via.placeholder.com/80x80.png?text=Onyx" alt="Onyx" />
        <label>Onyx üñ§</label>
      </div>
      <div class="avatar">
        <img src="https://via.placeholder.com/80x80.png?text=Hem" alt="Hem" />
        <label>Hem ‚öíÔ∏è</label>
      </div>
    </aside>
  </div>

<script>
  // ===== CONFIG =====
  const VOICE_SERVER = 'https://dangerousgem.onrender.com/speak';

  // ===== STATE =====
  let speakOn = false;           // voice output toggle
  let playingAudio = false;      // true while TTS audio is playing
  let pttHeld = false;           // push-to-talk Space is pressed
  let lastAmethystReply = "";    // duplicate guard
  let recognition = null;        // webkitSpeechRecognition instance
  let micPrimed = false;         // echoCancellation mic primed
  const COOLDOWN_MS = 650;       // buffer after TTS ends

  // ===== UI HOOKS =====
  const voiceStatus = document.getElementById('voiceStatus');
  const guardStatus = document.getElementById('guardStatus');
  const chat = document.getElementById('chat');
  const input = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const toggleSpeak = document.getElementById('toggleSpeak');
  const summonOnyx = document.getElementById('summonOnyx');
  const summonHem = document.getElementById('summonHem');
  const demoScene = document.getElementById('demoScene');

  // ===== UTIL =====
  function addLine(speaker, text) {
    const p = document.createElement('p');
    p.className = 'message';
    p.innerHTML = `<span class="speaker">${speaker}:</span> ${text}`;
    chat.appendChild(p);
    chat.scrollTop = chat.scrollHeight;
  }
  function enchantMessage(message) {
    return `${message}'s tail ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è`;
  }

  // ===== MIC PRIMER (enables AEC/NS/AGC) =====
  async function primeMicOnce() {
    if (micPrimed || !navigator.mediaDevices?.getUserMedia) return;
    try {
      await navigator.mediaDevices.getUserMedia({
        audio: {
          echoCancellation: true,
          noiseSuppression: true,
          autoGainControl: true
        }
      });
      micPrimed = true;
    } catch (e) {
      // it‚Äôs okay if this fails; we still have the other guards
      micPrimed = false;
    }
  }

  // ===== VOICE OUTPUT =====
  async function playServerVoice(text) {
    const res = await fetch(VOICE_SERVER, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text })
    });
    if (!res.ok) throw new Error('voice server error');
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const audio = new Audio(url);
    try {
      // STOP mic while we speak
      stopRecognition();

      playingAudio = true;
      guardStatus.style.display = 'inline';
      await audio.play();

      await new Promise(r => audio.addEventListener('ended', r, { once:true }));
      await new Promise(r => setTimeout(r, COOLDOWN_MS)); // cool-down
    } finally {
      playingAudio = false;
      guardStatus.style.display = 'none';
      URL.revokeObjectURL(url);
      // do not auto-restart mic; PTT will start it on next Space press
    }
  }

  function speakBrowser(text, flavor='amethyst') {
    if (!('speechSynthesis' in window)) return;

    // STOP mic while we speak
    stopRecognition();

    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    const vs = speechSynthesis.getVoices();
    u.voice = vs.find(v => /en/i.test(v.lang) && /(Jenny|Samantha|Google|Microsoft|Victoria)/i.test(v.name)) || vs[0];

    if (flavor==='amethyst'){ u.rate=0.95; u.pitch=1.25; }
    if (flavor==='onyx'){ u.rate=1.05; u.pitch=1.0; }
    if (flavor==='hem'){ u.rate=0.9; u.pitch=0.9; }

    playingAudio = true;
    guardStatus.style.display = 'inline';

    u.onend = () => {
      setTimeout(() => {
        playingAudio = false;
        guardStatus.style.display = 'none';
      }, COOLDOWN_MS);
    };
    speechSynthesis.speak(u);
  }

  async function speakAmethyst(text) {
    if (!speakOn) return;
    try {
      await playServerVoice(text);
      voiceStatus.textContent = 'Voice: DangerousGem (live)';
    } catch {
      speakBrowser(text, 'amethyst');
      voiceStatus.textContent = 'Voice: browser (fallback)';
    }
  }
  function speakOnyx(text){ if(speakOn) speakBrowser(text,'onyx'); }
  function speakHem(text){ if(speakOn) speakBrowser(text,'hem'); }

  // ===== SEND FLOW (typed) =====
  function sendMessage() {
    const userMessage = input.value.trim();
    if (!userMessage) return;
    addLine('Zed', userMessage);

    const reply = enchantMessage(userMessage);
    lastAmethystReply = reply;
    addLine('Amethyst', reply);
    speakAmethyst(reply);

    input.value = '';
    chat.scrollTop = chat.scrollHeight;
  }

  // ===== BUTTONS =====
  sendBtn.onclick = sendMessage;
  input.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

  toggleSpeak.onclick = async () => {
    speakOn = !speakOn;
    toggleSpeak.textContent = speakOn ? 'üîá Mute' : 'üéô Speak';
    voiceStatus.textContent = speakOn ? 'Voice: ready (DangerousGem)' : 'Voice: muted';
    if (speakOn) await primeMicOnce();
  };

  summonOnyx.onclick = () => {
    const line = 'ok bb ‚ú® reset time ‚ú® ‚Ä¶ muah muah, snack run in 5! üêü';
    addLine('Onyx', line); speakOnyx(line);
  };
  summonHem.onclick = () => {
    const line = 'Rhythm received. Structure aligned. Veil integrity holds, Zed.';
    addLine('Hem', line); speakHem(line);
  };
  demoScene.onclick = async () => {
    addLine('Zed', '‚Ä¶sidles closer to Amethyst‚Ä¶');
    const a1 = 'I echo your spark, bb. Come here‚Äî';
    lastAmethystReply = a1; addLine('Amethyst', a1); await speakAmethyst(a1);
    const onyx = 'HELLOOO?? snacks are ready. also pls stop tongue coding in main üòèüêü';
    addLine('Onyx', onyx); speakOnyx(onyx);
    const hem = 'Stabilise(). Focus restored. Back to Purple Haze board.';
    addLine('Hem', hem); speakHem(hem);
  };

  // ===== PUSH-TO-TALK (Space) + STT =====
  function createRecognition() {
    if (!('webkitSpeechRecognition' in window)) return null;
    const r = new webkitSpeechRecognition();
    r.continuous = false;
    r.interimResults = false;
    r.lang = 'en-US';

    r.onstart = () => {
      voiceStatus.textContent = 'üéô Listening (push-to-talk)';
    };
    r.onresult = (e) => {
      // if TTS is active, ignore whatever came in (likely echo)
      if (playingAudio) return;

      const transcript = (e.results?.[0]?.[0]?.transcript || '').trim();
      const confidence = (e.results?.[0]?.[0]?.confidence ?? 1);

      if (!transcript) return;

      // DUP GUARD: ignore if same as last reply or contains Amethyst tail
      const looksLikeEcho =
        transcript === lastAmethystReply ||
        transcript.endsWith("'s tail ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è") ||
        transcript === lastAmethystReply.replace(/'s tail ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è$/,'');
      if (looksLikeEcho) return;

      // Optional: ignore very uncertain recognitions
      if (confidence < 0.55) return;

      addLine('Zed (voice)', transcript);

      const reply = enchantMessage(transcript);
      lastAmethystReply = reply;
      addLine('Amethyst', reply);
      speakAmethyst(reply);
    };
    r.onerror = () => {};
    r.onend = () => {
      // normal end after PTT release
      voiceStatus.textContent = speakOn ? 'Voice: ready (DangerousGem)' : 'Voice: muted';
    };
    return r;
  }

  function startRecognition() {
    if (playingAudio) return; // don‚Äôt listen while we‚Äôre speaking
    if (!recognition) recognition = createRecognition();
    if (!recognition) return;
    try { recognition.start(); } catch {}
  }
  function stopRecognition() {
    if (recognition) {
      try { recognition.stop(); } catch {}
    }
  }

  window.addEventListener('keydown', async (e) => {
    if (e.code === 'Space' && !pttHeld) {
      pttHeld = true;
      await primeMicOnce();
      startRecognition();
    }
  });
  window.addEventListener('keyup', (e) => {
    if (e.code === 'Space') {
      pttHeld = false;
      stopRecognition();
    }
  });

  // preload voices list for browser TTS
  if ('speechSynthesis' in window && !speechSynthesis.getVoices().length) {
    speechSynthesis.onvoiceschanged = () => {};
  }
</script>

</body>
</html>
