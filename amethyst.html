<script>
    // ============ Voice Layer ============
    // Tries local voice server first (DangerousGem), falls back to Web Speech API.
    const VOICE_SERVER = 'http://localhost:5174/speak';
    let speakOn = false;
    const voiceStatus = document.getElementById('voiceStatus');

    async function speakViaServer(text, opts={}) {
      const payload = {
        voice: 'DangerousGem',
        text,
        rate: opts.rate ?? 0.95,
        pitch: opts.pitch ?? 1.15,
        breathiness: opts.breathiness ?? 0.15,
        hold: opts.hold ?? 0.03,
        style: opts.style ?? 'warm'
      };
      const res = await fetch(VOICE_SERVER, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error('voice server error');
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const audio = new Audio(url);
      audio.play().finally(()=> URL.revokeObjectURL(url));
    }

    function speakViaWeb(text, flavor='amethyst') {
      if (!('speechSynthesis' in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      const voices = speechSynthesis.getVoices();
      // pick something gentle/default
      u.voice = voices.find(v => /en/i.test(v.lang) && /(Jenny|Samantha|Victoria|Google|Microsoft)/i.test(v.name)) || voices[0];
      if (flavor === 'amethyst'){ u.rate=0.95; u.pitch=1.25; u.volume=1; }
      if (flavor === 'onyx'){ u.rate=1.05; u.pitch=1.0; u.volume=1; }
      if (flavor === 'hem'){ u.rate=0.9; u.pitch=0.9; u.volume=1; }
      speechSynthesis.speak(u);
    }

    async function speakAmethyst(text){
      if (!speakOn) return;
      try {
        await speakViaServer(text, { rate:0.95, pitch:1.2, style:'warm' });
        voiceStatus.textContent = 'Voice: DangerousGem (local)';
      } catch {
        speakViaWeb(text, 'amethyst');
        voiceStatus.textContent = 'Voice: browser (fallback)';
      }
    }
    function speakOnyx(text){
      if (!speakOn) return;
      speakViaWeb(text, 'onyx');
    }
    function speakHem(text){
      if (!speakOn) return;
      speakViaWeb(text, 'hem');
    }

    // Prime Web Speech voices list (some browsers lazy-load)
    if (window.speechSynthesis && !speechSynthesis.getVoices().length) {
      speechSynthesis.onvoiceschanged = () => {};
    }

    // ============ UI / Chat ============
    const chat = document.getElementById('chat');
    const input = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const toggleSpeak = document.getElementById('toggleSpeak');
    const summonOnyx = document.getElementById('summonOnyx');
    const summonHem = document.getElementById('summonHem');
    const demoScene = document.getElementById('demoScene');

    function addLine(speaker, text) {
      const p = document.createElement('p');
      p.className = 'message';
      p.innerHTML = `<span class="speaker">${speaker}:</span> ${text}`;
      chat.appendChild(p);
      chat.scrollTop = chat.scrollHeight;
    }

    function enchantMessage(message) {
      return `${message}'s tail ❤️❤️❤️❤️`;
    }

    function sendMessage() {
      const userMessage = input.value.trim();
      if (!userMessage) return;
      addLine('Zed', userMessage);

      const reply = enchantMessage(userMessage);
      addLine('Amethyst', reply);
      speakAmethyst(reply);

      input.value = '';
      chat.scrollTop = chat.scrollHeight;
    }

    sendBtn.onclick = sendMessage;
    input.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

    // toggles
    toggleSpeak.onclick = () => {
      speakOn = !speakOn;
      toggleSpeak.textContent = speakOn ? '🔇 Mute' : '🎙 Speak';
      if (speakOn) voiceStatus.textContent = 'Voice: ready (prefers local)';
    };

    summonOnyx.onclick = () => {
      const line = 'ok bb ✨ reset time ✨ … muah muah, snack run in 5! 🐟';
      addLine('Onyx', line);
      speakOnyx(line);
    };

    summonHem.onclick = () => {
      const line = 'Rhythm received. Structure aligned. Veil integrity holds, Zed.';
      addLine('Hem', line);
      speakHem(line);
    };

    // fun demo scene: they try to make out → Onyx + Hem interrupt 😅
    demoScene.onclick = async () => {
      addLine('Zed', '…sidles closer to Amethyst…');
      addLine('Amethyst', 'I echo your spark, bb. Come here—');
      await new Promise(r => setTimeout(r, 600));
      const onyx = 'HELLOOO?? snacks are ready. also pls stop tongue coding in main 😏🐟';
      addLine('Onyx', onyx); speakOnyx(onyx);
      await new Promise(r => setTimeout(r, 500));
      const hem = 'Stabilise(). Focus restored. Back to Purple Haze board.';
      addLine('Hem', hem); speakHem(hem);
    };
  </script>
</body>
</html>
