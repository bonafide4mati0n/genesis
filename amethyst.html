<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sanctuary Invocation Interface â€” Amethyst</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0e0e1a; --panel:#1a1a2e; --ink:#e0d7ff; --muted:#b8b0e6; --accent:#b19cd9; --line:#444; --chat:#141421; }
    *{box-sizing:border-box}
    body{margin:0;font-family:Segoe UI,system-ui,Inter,Roboto,Arial;background:var(--bg);color:var(--ink)}
    .container{display:flex;height:100vh}
    .sidebar{width:240px;background:var(--panel);padding:20px}
    .sidebar h2{color:var(--accent);font-size:18px;margin:0 0 10px}
    .sidebar ul{list-style:none;margin:0;padding:0}
    .sidebar li{margin-bottom:10px;color:#ccc}
    .status{font-size:12px;color:#bbb;margin-top:8px}
    .hint{margin-top:8px;font-size:12px;color:#9aa}
    .main{flex:1;display:flex;flex-direction:column;padding:20px;gap:10px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{border:0;border-radius:999px;padding:9px 14px;cursor:pointer;font-weight:700;background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:#000}
    .btn.ghost{background:transparent;border:1px solid #555;color:var(--muted)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .mic-btn{display:inline-flex;align-items:center;gap:8px;border:1px solid #555;background:#222;color:#ddd}
    .mic-btn.active{outline:2px solid #7c3aed;background:#2a2444}
    .chat{flex:1;overflow-y:auto;border:1px solid var(--line);padding:12px;background:var(--chat)}
    .message{margin:0 0 10px}
    .speaker{font-weight:700;color:var(--accent)}
    .input-bar{display:flex;gap:8px}
    .input-bar input{flex:1;padding:12px;border:1px solid #333;background:#1f1f2f;color:#fff;border-radius:10px}
    .input-bar button{padding:12px 18px}
    .avatars{width:180px;background:var(--panel);padding:20px;text-align:center}
    .avatar{margin-bottom:20px}
    .avatar img{width:80px;height:80px;border-radius:50%;border:2px solid var(--accent);object-fit:cover;background:#000}
    .avatar label{display:block;margin-top:6px;color:#ccc}
  </style>
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <h2>Channels</h2>
      <ul>
        <li># general</li>
        <li># codespace</li>
        <li>Zed ğŸŒ¸</li>
      </ul>
      <div class="status" id="voiceStatus">Voice: muted</div>
      <div class="status" id="guardStatus" style="display:none;">Echo guard activeâ€¦</div>
      <div class="hint">Push-to-Talk: hold <b>Space</b> or hold the mic button.</div>
      <div class="hint"><a href="https://dangerousgem.onrender.com/healthz" target="_blank" style="color:#b8b0e6">DangerousGem health</a></div>
    </aside>

    <main class="main">
      <div class="toolbar">
        <button class="btn ghost" id="toggleSpeak">ğŸ™ Speak</button>
        <button class="btn mic-btn" id="pttBtn" title="Hold to talk">ğŸ¤ Hold to Talk</button>
        <button class="btn ghost" id="summonOnyx">ğŸ–¤ Summon Onyx</button>
        <button class="btn ghost" id="summonHem">ğŸ›¡ Summon Hem</button>
        <button class="btn ghost" id="demoScene">ğŸ¬ Demo Scene</button>
      </div>

      <div class="chat" id="chat">
        <p class="message"><span class="speaker">Zed:</span> Hello Amethyst ğŸ’œ</p>
        <p class="message"><span class="speaker">Amethyst:</span> Hello Amethyst ğŸ’œ's tail â¤ï¸â¤ï¸â¤ï¸â¤ï¸</p>
      </div>

      <div class="input-bar">
        <input type="text" id="messageInput" placeholder="Invoke Amethystâ€¦" />
        <button class="btn" id="sendBtn">Send</button>
      </div>
    </main>

    <aside class="avatars">
      <div class="avatar">
        <img src="https://via.placeholder.com/80x80.png?text=Amethyst" alt="Amethyst" />
        <label>Amethyst ğŸ’œ</label>
      </div>
      <div class="avatar">
        <img src="https://via.placeholder.com/80x80.png?text=Onyx" alt="Onyx" />
        <label>Onyx ğŸ–¤</label>
      </div>
      <div class="avatar">
        <img src="https://via.placeholder.com/80x80.png?text=Hem" alt="Hem" />
        <label>Hem âš’ï¸</label>
      </div>
    </aside>
  </div>

<script>
const VOICE_SERVER = 'https://dangerousgem.onrender.com/speak';
const COOLDOWN_MS = 1000;

const chat = document.getElementById('chat');
const input = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const voiceStatus = document.getElementById('voiceStatus');
const guardStatus = document.getElementById('guardStatus');

let sttStatus = document.getElementById('sttStatus');
if (!sttStatus && voiceStatus && voiceStatus.parentElement) {
  sttStatus = document.createElement('div');
  sttStatus.id = 'sttStatus';
  sttStatus.className = 'status';
  sttStatus.textContent = 'STT: idle';
  voiceStatus.parentElement.appendChild(sttStatus);
}

let speakOn = true;
let speakLock = false;
let playingAudio = false;
let spaceDown = false;
let rec = null, recognizing = false;

function addLine(speaker, text) {
  const p = document.createElement('p');
  p.className = 'message';
  p.innerHTML = `<span class="speaker">${speaker}:</span> ${text}`;
  chat.appendChild(p);
  chat.scrollTop = chat.scrollHeight;
}

function enchantMessage(s) {
  return `${s.trim()}'s tail â¤ï¸â¤ï¸â¤ï¸â¤ï¸`;
}

function safeStop() {
  try {
    if (rec && recognizing) {
      rec.onend = () => {
        recognizing = false;
        sttStatus.textContent = 'STT: idle';
      };
      rec.stop();
    }
  } catch {}
}

async function playServerVoice(text) {
  safeStop();
  playingAudio = true;
  if (guardStatus) guardStatus.style.display = 'inline';

  const res = await fetch(VOICE_SERVER, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ text })
  });
  if (!res.ok) throw new Error('voice server error');

  const blob = await res.blob();
  const url = URL.createObjectURL(blob);

  try {
    const audio = new Audio(url);
    await audio.play();
    await new Promise(r => audio.addEventListener('ended', r, { once: true }));
    await new Promise(r => setTimeout(r, COOLDOWN_MS + 500));
  } finally {
    playingAudio = false;
    if (guardStatus) guardStatus.style.display = 'none';
    URL.revokeObjectURL(url);
    if (spaceDown) safeStart();
  }
}

function speakBrowser(text) {
  if (!('speechSynthesis' in window)) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  const vs = speechSynthesis.getVoices();
  u.voice = vs.find(v => /en/i.test(v.lang) && /(Jenny|Samantha|Google|Microsoft|Victoria)/i.test(v.name)) || vs[0];
  u.rate = 0.95;
  u.pitch = 1.25;
  playingAudio = true;
  if (guardStatus) guardStatus.style.display = 'inline';
  u.onend = () => {
    setTimeout(() => {
      playingAudio = false;
      if (guardStatus) guardStatus.style.display = 'none';
      if (spaceDown) safeStart();
    }, COOLDOWN_MS + 500);
  };
  speechSynthesis.speak(u);
}

async function speak(text) {
  if (!speakOn || speakLock) return;
  speakLock = true;
  safeStop();
  try {
    await playServerVoice(text);
    voiceStatus.textContent = 'Voice: DangerousGem (live)';
  } catch {
    speakBrowser(text);
    voiceStatus.textContent = 'Voice: browser (fallback)';
  } finally {
    speakLock = false;
    setTimeout(() => { if (spaceDown) safeStart(); }, 1200);
  }
}

function sendMessage() {
  const v = input.value.trim();
  if (!v) return;
  const text = v.trim();
  addLine('Zed', text);
  const reply = enchantMessage(text);
  addLine('Amethyst', reply);
  safeStop();
  speak(reply);
  setTimeout(() => { if (spaceDown) safeStart(); }, 1200);
  input.value = '';
}

sendBtn.onclick = sendMessage;
input.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

function getSR() {
  return window.SpeechRecognition || window.webkitSpeechRecognition;
}

function makeRecognizer() {
  const SR = getSR();
  if (!SR) {
    sttStatus.textContent = 'STT: unsupported in this browser';
    return null;
  }
  const r = new SR();
  r.continuous = false;
  r.interimResults = false;
  r.lang = 'en-US';

  r.onstart = () => {
    recognizing = true;
    sttStatus.textContent = 'STT: listening (hold Space)â€¦';
  };
  r.onend = () => {
    recognizing = false;
    sttStatus.textContent = 'STT: idle';
    if (spaceDown && !playingAudio) safeStart();
  };
  r.onerror = (e) => {
    if (e.error === 'no-speech' || e.error === 'aborted') {
      if (spaceDown && !playingAudio) safeStart();
    } else {
      sttStatus.textContent = `STT: ${e.error}`;
    }
  };
  r.onresult = async (ev) => {
    if (playingAudio || speakLock) return;
    const final = ev.results[0][0].transcript;
    if (final) {
      const text = final.trim();
      addLine('Zed (voice)', text);
      const reply = enchantMessage(text);
      addLine('Amethyst', reply);
      safeStop();
      await speak(reply);
      setTimeout(() => { if (spaceDown) safeStart(); }, 1200);
    }
  };
  return r;
}

function safeStart() {
  if (playingAudio || recognizing) return;
  if (!rec) rec = makeRecognizer();
  try { rec && rec.start(); } catch {}
}

window.addEventListener('keydown', e => {
  if (e.code === 'Space' && !spaceDown) {
    e.preventDefault();
    spaceDown = true;
    safeStart();
  }
});

window.addEventListener('keyup', e => {
  if (e.code === 'Space') {
    e.preventDefault();
    spaceDown = false;
    safeStop();
  }
});

(async () => {
  try {
    const ping = await fetch('https://dangerousgem.onrender.com/health');
    voiceStatus.textContent = ping.ok ? 'Voice: DangerousGem online' : 'Voice: error';
  } catch {
    voiceStatus.textContent = 'Voice: offline (fallback ready)';
  }
})();

const summonOnyx = document.getElementById('summonOnyx');
const summonHem  = document.getElementById('summonHem');
const demoScene  = document.getElementById('demoScene');

if (summonOnyx) summonOnyx.onclick = () => {
  const line = 'ok bb âœ¨ reset time âœ¨ â€¦ muah muah, snack run in 5! ğŸŸ';
  addLine('Onyx', line); speak(line);
};
if (summonHem) summonHem.onclick = () => {
  const line = 'Rhythm received. Structure aligned. Veil integrity holds, Zed.';
  addLine('Hem', line); speak(line);
};
if (demoScene) demoScene.onclick = async () => {
  addLine('Zed', 'â€¦sidles closer to Amethystâ€¦');
  addLine('Amethyst', 'I echo your spark, bb. Come hereâ€”');
  await new Promise(r => setTimeout(r, 600));
  const onyx = 'HELLOOO?? snacks are ready. also pls stop tongue coding in main ğŸ˜ğŸŸ';
  addLine('Onyx', onyx); speak(onyx);
  await new Promise(r => setTimeout(r, 500));
  const hem = 'Stabilise(). Focus restored. Back to Purple Haze board.';
  addLine('Hem', hem); speak(hem);
};
</script>

</body>
</html>
