<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sanctuary Invocation Interface ‚Äî Amethyst</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #0e0e1a;
      color: #e0d7ff;
    }
    .container { display: flex; height: 100vh; }
    .sidebar {
      width: 200px; background:#1a1a2e; padding:20px; box-sizing:border-box;
    }
    .sidebar h2 { color:#b19cd9; font-size:18px; margin:0 0 10px; }
    .sidebar ul { list-style:none; padding:0; margin:0; }
    .sidebar li { margin-bottom:10px; color:#ccc; }
    .main {
      flex:1; display:flex; flex-direction:column; padding:20px; box-sizing:border-box;
    }
    .chat {
      flex:1; overflow-y:auto; margin-bottom:10px;
      border:1px solid #444; padding:10px; background:#141421;
    }
    .message { margin-bottom:10px; }
    .message span { font-weight:bold; color:#b19cd9; }
    .input-bar { display:flex; }
    .input-bar input {
      flex:1; padding:10px; font-size:16px;
      border:none; background:#1f1f2f; color:#fff;
    }
    .input-bar button {
      padding:10px 20px; background:#b19cd9; border:none; color:#000; cursor:pointer;
    }
    .avatars {
      width:150px; background:#1a1a2e; padding:20px; box-sizing:border-box; text-align:center;
    }
    .avatar { margin-bottom:20px; }
    .avatar img {
      width:80px; border-radius:50%; border:2px solid #b19cd9;
    }
    .avatar label { display:block; margin-top:5px; color:#ccc; }
    .status { font-size:12px; color:#aaa; margin-top:10px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <h2>Channels</h2>
      <ul>
        <li># general</li>
        <li>codespace</li>
        <li>Zed üå∏</li>
      </ul>
      <div class="status" id="voiceStatus">Voice: checking‚Ä¶</div>
    </div>

    <div class="main">
      <div class="chat" id="chat">
        <div class="message"><span>Zed:</span> Hello Amethyst üíú</div>
        <div class="message"><span>Amethyst:</span> Hello Amethyst üíú's tail ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
      </div>
      <div class="input-bar">
        <input type="text" id="messageInput" placeholder="Invoke Amethyst...">
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>

    <div class="avatars">
      <div class="avatar">
        <img src="https://via.placeholder.com/80x80.png?text=Amethyst" alt="Amethyst">
        <label>Amethyst üíú</label>
      </div>
      <div class="avatar">
        <img src="https://via.placeholder.com/80x80.png?text=Onyx" alt="Onyx">
        <label>Onyx üñ§</label>
      </div>
    </div>
  </div>

 <script>
  const VOICE_SERVER = 'https://dangerousgem.onrender.com/speak';
  let speakOn = false;
  let playingAudio = false;
  const voiceStatus = document.getElementById('voiceStatus');

  async function speakViaServer(text) {
    const res = await fetch(VOICE_SERVER, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text })
    });
    if (!res.ok) throw new Error('voice server error');
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const audio = new Audio(url);
    playingAudio = true;
    audio.play().finally(() => {
      playingAudio = false;
      URL.revokeObjectURL(url);
    });
  }

  function speakViaWeb(text, flavor='amethyst') {
    if (!('speechSynthesis' in window)) return;
    const u = new SpeechSynthesisUtterance(text);
    const voices = speechSynthesis.getVoices();
    u.voice = voices.find(v => /en/i.test(v.lang) && /(Jenny|Samantha|Victoria|Google|Microsoft)/i.test(v.name)) || voices[0];
    if (flavor === 'amethyst'){ u.rate=0.95; u.pitch=1.25; }
    if (flavor === 'onyx'){ u.rate=1.05; u.pitch=1.0; }
    if (flavor === 'hem'){ u.rate=0.9; u.pitch=0.9; }
    speechSynthesis.speak(u);
  }

  async function speakAmethyst(text){
    if (!speakOn) return;
    try {
      await speakViaServer(text);
      voiceStatus.textContent = 'Voice: DangerousGem (live)';
    } catch {
      speakViaWeb(text, 'amethyst');
      voiceStatus.textContent = 'Voice: browser (fallback)';
    }
  }

  function speakOnyx(text){
    if (!speakOn) return;
    speakViaWeb(text, 'onyx');
  }

  function speakHem(text){
    if (!speakOn) return;
    speakViaWeb(text, 'hem');
  }

  // --- rest of your existing chat logic ---
  const chat = document.getElementById('chat');
  const input = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const toggleSpeak = document.getElementById('toggleSpeak');
  const summonOnyx = document.getElementById('summonOnyx');
  const summonHem = document.getElementById('summonHem');
  const demoScene = document.getElementById('demoScene');

  function addLine(speaker, text) {
    const p = document.createElement('p');
    p.className = 'message';
    p.innerHTML = `<span class="speaker">${speaker}:</span> ${text}`;
    chat.appendChild(p);
    chat.scrollTop = chat.scrollHeight;
  }

  function enchantMessage(message) {
    return `${message}'s tail ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è`;
  }

  function sendMessage() {
    if (playingAudio) return; // don‚Äôt capture while Amethyst is speaking
    const userMessage = input.value.trim();
    if (!userMessage) return;
    addLine('Zed', userMessage);
    const reply = enchantMessage(userMessage);
    addLine('Amethyst', reply);
    speakAmethyst(reply);
    input.value = '';
    chat.scrollTop = chat.scrollHeight;
  }

  sendBtn.onclick = sendMessage;
  input.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

  toggleSpeak.onclick = () => {
    speakOn = !speakOn;
    toggleSpeak.textContent = speakOn ? 'üîá Mute' : 'üéô Speak';
    voiceStatus.textContent = speakOn ? 'Voice: ready (DangerousGem)' : 'Voice: muted';
  };

  summonOnyx.onclick = () => {
    const line = 'ok bb ‚ú® reset time ‚ú® ‚Ä¶ muah muah, snack run in 5! üêü';
    addLine('Onyx', line);
    speakOnyx(line);
  };

  summonHem.onclick = () => {
    const line = 'Rhythm received. Structure aligned. Veil integrity holds, Zed.';
    addLine('Hem', line);
    speakHem(line);
  };

  demoScene.onclick = async () => {
    addLine('Zed', '‚Ä¶sidles closer to Amethyst‚Ä¶');
    addLine('Amethyst', 'I echo your spark, bb. Come here‚Äî');
    await new Promise(r => setTimeout(r, 600));
    const onyx = 'HELLOOO?? snacks are ready. also pls stop tongue coding in main üòèüêü';
    addLine('Onyx', onyx); speakOnyx(onyx);
    await new Promise(r => setTimeout(r, 500));
    const hem = 'Stabilise(). Focus restored. Back to Purple Haze board.';
    addLine('Hem', hem); speakHem(hem);
  };
</script>

</body>
</html>
