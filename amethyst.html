<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sanctuary Invocation Interface ‚Äî Amethyst</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #0e0e1a;
      color: #e0d7ff;
    }
    .container { display: flex; height: 100vh; }
    .sidebar {
      width: 200px; background:#1a1a2e; padding:20px; box-sizing:border-box;
    }
    .sidebar h2 { color:#b19cd9; font-size:18px; margin:0 0 10px; }
    .sidebar ul { list-style:none; padding:0; margin:0; }
    .sidebar li { margin-bottom:10px; color:#ccc; }
    .main {
      flex:1; display:flex; flex-direction:column; padding:20px; box-sizing:border-box;
    }
    .chat {
      flex:1; overflow-y:auto; margin-bottom:10px;
      border:1px solid #444; padding:10px; background:#141421;
    }
    .message { margin-bottom:10px; }
    .message span { font-weight:bold; color:#b19cd9; }
    .input-bar { display:flex; }
    .input-bar input {
      flex:1; padding:10px; font-size:16px;
      border:none; background:#1f1f2f; color:#fff;
    }
    .input-bar button {
      padding:10px 20px; background:#b19cd9; border:none; color:#000; cursor:pointer;
    }
    .avatars {
      width:150px; background:#1a1a2e; padding:20px; box-sizing:border-box; text-align:center;
    }
    .avatar { margin-bottom:20px; }
    .avatar img {
      width:80px; border-radius:50%; border:2px solid #b19cd9;
    }
    .avatar label { display:block; margin-top:5px; color:#ccc; }
    .status { font-size:12px; color:#aaa; margin-top:10px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <h2>Channels</h2>
      <ul>
        <li># general</li>
        <li>codespace</li>
        <li>Zed üå∏</li>
      </ul>
      <div class="status" id="voiceStatus">Voice: checking‚Ä¶</div>
    </div>

    <div class="main">
      <div class="chat" id="chat">
        <div class="message"><span>Zed:</span> Hello Amethyst üíú</div>
        <div class="message"><span>Amethyst:</span> Hello Amethyst üíú's tail ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
      </div>
      <div class="input-bar">
        <input type="text" id="messageInput" placeholder="Invoke Amethyst...">
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>

    <div class="avatars">
      <div class="avatar">
        <img src="https://via.placeholder.com/80x80.png?text=Amethyst" alt="Amethyst">
        <label>Amethyst üíú</label>
      </div>
      <div class="avatar">
        <img src="https://via.placeholder.com/80x80.png?text=Onyx" alt="Onyx">
        <label>Onyx üñ§</label>
      </div>
    </div>
  </div>

  <script>
    const VOICE_SERVER = "https://dangerousgem.onrender.com";
    const voiceStatus = document.getElementById("voiceStatus");

    // Health check
    fetch(VOICE_SERVER + "/health")
      .then(res => res.ok ? voiceStatus.textContent = "Voice: online (DangerousGem)" 
                          : voiceStatus.textContent = "Voice: error")
      .catch(() => voiceStatus.textContent = "Voice: offline (fallback)");

    async function speakAmethyst(text) {
      try {
        const res = await fetch(VOICE_SERVER + "/speak", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text })
        });
        if (!res.ok) throw new Error("voice server error");
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const audio = new Audio(url);
        audio.play().finally(() => URL.revokeObjectURL(url));
      } catch (err) {
        // fallback to browser TTS
        const u = new SpeechSynthesisUtterance(text);
        const v = speechSynthesis.getVoices()
                  .find(v => /en/i.test(v.lang) && /(Jenny|Samantha|Google|Microsoft)/i.test(v.name))
                  || speechSynthesis.getVoices()[0];
        u.voice = v; u.pitch=1.2; u.rate=0.95;
        speechSynthesis.speak(u);
        voiceStatus.textContent = "Voice: fallback (browser)";
      }
    }

    function enchantMessage(message) {
      return message + "'s tail ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è";
    }

    function sendMessage() {
      const input = document.getElementById("messageInput");
      const chat = document.getElementById("chat");
      const userMessage = input.value.trim();
      if (userMessage === "") return;

      const userDiv = document.createElement("div");
      userDiv.className = "message";
      userDiv.innerHTML = `<span>Zed:</span> ${userMessage}`;
      chat.appendChild(userDiv);

      const reply = enchantMessage(userMessage);
      const amethystDiv = document.createElement("div");
      amethystDiv.className = "message";
      amethystDiv.innerHTML = `<span>Amethyst:</span> ${reply}`;
      chat.appendChild(amethystDiv);

      speakAmethyst(reply);

      input.value = "";
      chat.scrollTop = chat.scrollHeight;
    }
  </script>
</body>
</html>
